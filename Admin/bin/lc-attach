#!/usr/bin/env python


import os
import sys
import time
from argparse import ArgumentParser

import lc_admin.tools as tools

parser = ArgumentParser()

#parser.add_argument("--nobarrier", action="store_true", default=False)
parser.add_argument('device_id', type=int)
parser.add_argument('cache_id', type=int)

args = parser.parse_args()

device_id = args.device_id
cache_id = args.cache_id

device = tools.Device(device_id)
		
device.lock()
if(device.cache_id()):		
	device.unlock()
	sys.exit("cache already attached.")
			
# Note changed. load -> reload
load_command = "echo 0 %d lc %d %s %d | dmsetup reload %s" % \
				(device.size(), device_id, device.no(), cache_id, device.dm_name())
print("attach command: %s" % (load_command))

remove_command = "dmsetup message %s 0 remove_sysfs" % (device.dm_name())
print(remove_command)
os.system(remove_command)

print(load_command)
os.system(load_command)
device.unlock()

#time.sleep(3)
#os.system("wait") # will deadlock????
attach_command = "dmsetup message %s 0 add_sysfs" % device.dm_name()
print(attach_command)
os.system(attach_command)
