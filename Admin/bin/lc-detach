#!/usr/bin/env python

import os
from argparse import ArgumentParser

import lc_admin.tools as tools

parser = ArgumentParser()

parser.add_argument('device_id', type=int)

args = parser.parse_args()

device_id = args.device_id

device = tools.Device(device_id)

device.lock()
if not device.cache_id():
	device.unlock()
	sys.exit("cache not bound")

cache = tools.Cache(device.cache_id())
dirnode.write(cache.lc_node, "flush_current_buffer", 1)

try:
	while(device.nr_dirty_caches()):	
		print("could not detach the device. %d caches are still dirty remained." % (device.nr_dirty_caches()))
		time.sleep(1)	

	os.system("dmsetup message %s 0 remove_sysfs" % (device.dm_name()))
	os.system("echo 0 %d lc %d %s 0 | dmsetup reload %s" % 
			(device.size(), device_id, device.backing.path(), device.dm_name()))

	device.unlock()
	os.system("dmsetup message %s 0 add_sysfs" % (device.dm_name()))
	
except KeyboardInterrupt:
	device.unlock()
	sys.exit()
