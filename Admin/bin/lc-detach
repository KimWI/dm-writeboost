#!/usr/bin/env python

import os
from argparse import ArgumentParser

import lc_admin.tools as tools

parser = ArgumentParser()

parser.add_argument('device_id', type=int)

args = parser.parse_args()

device = tools.Device(device_id)

if not device.cache_id():
	sys.exit("cache not bound")

device.lock()
cache = tools.Cache(device.cache_id())
cache.flush_current_buffer()

try:
	while(device.nr_dirty_caches()):	
		print("could not detach the device. %d caches are still dirty remained." % (device.nr_dirty_caches()))
		time.sleep(1)	

	# FIXME	
	os.system("echo 0 > /sys/module/dm_lc/devices/%d/cache_id" % (device_id))
except KeyboardInterrupt:
	pass

device.unlock()
