#!/usr/bin/env python

import os
import sys
import time
from argparse import ArgumentParser

import lc_admin.dirnode as dirnode
import lc_admin.tools as tools

parser = ArgumentParser()

parser.add_argument('device_id', type=int)

args = parser.parse_args()

device_id = args.device_id

device = tools.Device(device_id)

device.lock()
if not device.cache_id():
	device.unlock()
	sys.exit("cache not bound")

cache = tools.Cache(device.cache_id())
dirnode.write(cache.lc_node, "flush_current_buffer", 1)

interrupted = False

while True:
	try:
		nr = lambda : device.nr_dirty_caches()
		while nr():
			if interrupted:
				device.unlock()
				sys.exit()

			print("could not detach the device. %d caches are still dirty remained." % (nr()))
			time.sleep(1)

		print("no dirty cache remained in the device")	

	except KeyboardInterrupt:
		interrupted = True
		continue

	finally:

		load_command = "echo 0 %d lc %d %s 0 | dmsetup reload %s" % \
				(device.size(), device_id, device.backing.path(), device.dm_name())

		os.system("dmsetup message %s 0 remove_sysfs" % (device.dm_name()))
		os.system(load_command)

		device.unlock()
		os.system("dmsetup message %s 0 add_sysfs" % (device.dm_name()))
		break
