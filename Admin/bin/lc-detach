#!/usr/bin/env python

import os
from argparse import ArgumentParser

import lc_admin.tools as tools

parser = ArgumentParser()

parser.add_argument('device_id', type=int)

args = parser.parse_args()

device_id = args.device_id

device = tools.Device(device_id)

device.lock()
if not device.cache_id():
	device.unlock()
	sys.exit("cache not bound")

cache = tools.Cache(device.cache_id())
dirnode.write(cache.lc_node, "flush_current_buffer", 1)

interrupted = False

while True:
	try:
		nr = device.nr_dirty_caches()
		while nr:
			if interrupted:
				device.unlock()
				sys.exit()

			print("could not detach the device. %d caches are still dirty remained." % (nr))
			time.sleep(1)

	except KeyboardInterrupt:
		interrupted = True
		continue

	finally:
		os.system("dmsetup message %s 0 remove_sysfs" % (device.dm_name()))
		os.system("echo 0 %d lc %d %s 0 | dmsetup reload %s" %
			(device.size(), device_id, device.backing.path(), device.dm_name()))

		device.unlock()
		os.system("dmsetup message %s 0 add_sysfs" % (device.dm_name()))
