#!/bin/sh

dmsetup create writeboost-mgr --table "0 1 writeboost-mgr"

. ./config

cd Admin
python setup.py install
cd -

# Discard the whole cache device before formatting
# blkdiscard command is included in upstream util-linux.
# But don't worry, without discarding, dm-lc works correctly.
# This is only a performance-relevant issue.
blkdiscard --offset 0 --length `blockdev --getsize64 ${CACHE}` ${CACHE}

echo writeboost-format-cache ...
time writeboost-format-cache ${CACHE}

echo writeboost-create ...
writeboost-create perflv 5 ${BACKING}

echo writeboost-resume-cache ...
time writeboost-resume-cache 3 ${CACHE}

echo writeboost-attach ...
writeboost-attach 5 3

echo writeboost-daemon start ...
# To disable automated controll by writeboost-daemon.
# Comment out this line.
writeboost-daemon start

echo 1 > /sys/module/dm_writeboost/caches/3/flush_current_buffer_interval
echo 1 > /sys/module/dm_writeboost/caches/3/commit_super_block_interval
