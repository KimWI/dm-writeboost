#!/bin/sh

. ./config

echo 7 > /proc/sys/kernel/printk

sz=`blockdev --getsize ${CACHE}`
dmsetup create cache-flakey --table "0 ${sz} flakey ${CACHE} 0 5 0"
CACHE=/dev/mapper/cache-flakey

sz=`blockdev --getsize ${BACKING}`
dmsetup create backing-flakey --table "0 ${sz} flakey ${BACKING} 0 20 0"
BACKING=/dev/mapper/backing-flakey

# Discard the whole cache device before formatting
# blkdiscard command is included in upstream util-linux.
# But don't worry, without discarding, dm-lc works correctly.
# This is only a performance-relevant issue.
blkdiscard --offset 0 --length `blockdev --getsize64 ${CACHE}` ${CACHE}

# Zeroing the first sector in the cache device
# triggers formatting the cache device
echo destory cache ... 
dd if=/dev/zero of=${CACHE} bs=512 count=1 oflag=direct

echo create writeboost-vol ...
# dmsetup create writeboost-vol --table "0 ${sz} writeboost ${BACKING} ${CACHE} 10 8192"
dmsetup create writeboost-vol --table "0 ${sz} writeboost ${BACKING} ${CACHE}"

if test $? -ne 0; then
    echo "initialization failed. see dmseg"
    exit
fi

echo configure things for tests ...
# dmsetup message writeboost-vol 0 barrier_deadline_ms 1000
dmsetup message writeboost-vol 0 enable_migration_modulator 1
dmsetup message writeboost-vol 0 update_record_interval 2
dmsetup message writeboost-vol 0 sync_interval 3

# To disable migration except urgent ones
# enable these two lines.
# dmsetup message writeboost-vol 0 enable_migration_modulator 0
# dmsetup message writeboost-vol 0 allow_migrate 0
