#!/bin/sh

. ./config

# Discard the whole cache device before formatting
# blkdiscard command is included in upstream util-linux.
# But don't worry, without discarding, dm-lc works correctly.
# This is only a performance-relevant issue.
blkdiscard --offset 0 --length `blockdev --getsize64 ${CACHE}` ${CACHE}

# Zeroing the first sector in the cache device
# triggers formatting the cache device
echo destory cache ... 
dd if=/dev/zero of=${CACHE} bs=512 count=1 oflag=direct

echo create perflv ...
sz=`blockdev --getsize ${BACKING}`
dmsetup create perflv --table "0 ${sz} writeboost ${BACKING} ${CACHE}"

echo configure things for tests ...
dmsetup message perflv 0 enable_migration_modulator 1
dmsetup message perflv 0 update_record_interval 2
dmsetup message perflv 0 flush_current_buffer_interval 3
